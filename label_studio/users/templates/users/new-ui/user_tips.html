{% load filters %}

<script nonce="{{request.csp_nonce}}">

  const SERVER_ID = {{ request.server_id|json_dumps_ensure_ascii|safe }};
  const EVENT_NAMESPACE_KEY = "heidi_tips";
  // 修改了缓存Key，防止浏览器读取旧的英文缓存
  const CACHE_KEY = "heidi_live_tips_collection_cn_v1";
  const CACHE_FETCHED_AT_KEY = "heidi_live_tips_collection_fetched_at";
  const CACHE_STALE_TIME = 1000 * 60 * 60; // 1 hour
  const MAX_TIMEOUT = 5000; // 5 seconds
  const TIP_COLLECTION_NAME = "authPage";

  // 这里是核心汉化部分
  const defaultTipsCollection = {
    authPage: [
      {
        title: "你知道吗？",
        description:
          "您可以同步来自主流云存储提供商的数据，在上传时自动收集新项目进行标注，并返回标注结果以训练和持续改进模型。",
        link: {
          label: "了解更多",
          url: "https://labelstud.io/guide/storage",
          params: {
            experiment: "login_revamp",
            treatment: "sync_cloud_data",
          },
        },
      },
      {
        title: "你知道吗？",
        description:
          "Label Studio 企业版拥有更多功能和自动化工具，可以更快速地标注数据，同时确保最高质量。",
        link: {
          label: "了解更多",
          url: "https://humansignal.com/goenterprise/",
          params: {
            experiment: "login_revamp",
            treatment: "enterprise_platform",
          },
        },
      },
      {
        title: "你知道吗？",
        description:
          "Label Studio 拥有数十种针对各类数据类型的预构建模板，从图像分类到情感分析，再到大模型微调(LLM Fine-tuning)，您都可以直接使用。",
        link: {
          label: "查看所有模板",
          url: "https://labelstud.io/templates",
          params: {
            experiment: "login_revamp",
            treatment: "templates",
          },
        },
      },
      {
        title: "你知道吗？",
        description: "Label Studio 现已推出针对小型团队和项目优化的 Starter Cloud 服务。",
        link: {
          label: "了解更多",
          url: "https://humansignal.com/pricing/",
          params: {
            experiment: "login_revamp",
            treatment: "starter_cloud"
          }
        }
      },
    ],
  };

  function createURL(url, params) {
    const base = new URL(url);

    Object.entries(params ?? {}).forEach(([key, value]) => {
      base.searchParams.set(key, value);
    });

    if (SERVER_ID) base.searchParams.set("server_id", SERVER_ID);

    return base.toString()
  }

  const loadLiveTipsCollection = () => {
    // 强制直接返回本地汉化内容，不再去请求远程的英文内容
    // 如果你希望保留远程更新功能（可能是英文），请删除下面这一行 return defaultTipsCollection;
    return defaultTipsCollection;

    /* 下面的远程获取逻辑已屏蔽，以确保显示中文 */
    /*
    const cachedData = localStorage.getItem(CACHE_KEY);
    const fetchedAt = localStorage.getItem(CACHE_FETCHED_AT_KEY);

    if (cachedData && fetchedAt && Date.now() - Number.parseInt(fetchedAt) < CACHE_STALE_TIME) {
      return JSON.parse(cachedData);
    }

    const abortController = new AbortController();
    const abortTimeout = setTimeout(abortController.abort, MAX_TIMEOUT);

    fetch("/heidi-tips", {
      headers: {
        "Cache-Control": "no-cache",
        "Content-Type": "application/json",
      },
      signal: abortController.signal,
    })
      .then(async (response) => {
        if (response.ok) {
          const data = await response.json();
          localStorage.setItem(CACHE_FETCHED_AT_KEY, String(Date.now()));
          localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        }
      })
      .catch((e) => {
        console.warn("Failed to load live Heidi tips collection", e);
      })
      .finally(() => {
        clearTimeout(abortTimeout);
      });

    if (cachedData) {
      return JSON.parse(cachedData);
    }
    return defaultTipsCollection;
    */
  };

  function getRandomTip() {
    const tipsCollection = loadLiveTipsCollection();

    if (!tipsCollection[TIP_COLLECTION_NAME]) return null;

    const tips = tipsCollection[TIP_COLLECTION_NAME];

    const index = Math.floor(Math.random() * tips.length);

    return tips[index];
  }

  function getTipCollectionEvent(collection, event) {
    return `${EVENT_NAMESPACE_KEY}.${collection}.${event}`;
  }

  function getTipEvent(collection, tip, event) {
    if (tip.link.params?.experiment && tip.link.params?.treatment) {
      return `${EVENT_NAMESPACE_KEY}.${collection}.${tip.link.params?.experiment}.${tip.link.params?.treatment}.${event}`;
    }
    if (tip.link.params?.experiment) {
      return `${EVENT_NAMESPACE_KEY}.${collection}.${tip.link.params?.experiment}.${event}`;
    }
    if (tip.link.params?.treatment) {
      return `${EVENT_NAMESPACE_KEY}.${collection}.${tip.link.params?.treatment}.${event}`;
    }

    return getTipCollectionEvent(collection, event);
  }

  function getTipMetadata(tip) {
    const { experiment, treatment, ...rest } = tip.link.params ?? {};
    return {
      ...rest,
      content: tip.description ?? tip.content ?? "",
      title: tip.title,
      href: tip.link.url,
      label: tip.link.label,
    };
  }

  document.addEventListener('DOMContentLoaded', function() {
    const _container = document.querySelector('.tips');
    const _title = document.querySelector('.tips .title');
    const _description = document.querySelector('.tips .description');

    const selectedTip = getRandomTip();
    if (!selectedTip) {
      _container.remove();
      return;
    }

    _container.addEventListener('click', (event) => {
      if (event.target.hasAttribute('data-heidi-tip-link')) {
        __lsa(getTipEvent(TIP_COLLECTION_NAME, selectedTip, 'click'), getTipMetadata(selectedTip));
      }
    });

    const linkUrl = createURL(selectedTip.link.url, selectedTip.link.params)

    _title.innerHTML = selectedTip.title;
    _description.innerHTML = `${selectedTip.description} <a data-heidi-tip-link href="${linkUrl}" target="_blank">${selectedTip.link.label}</a>`;
  });
</script>

<div class="tips">
  <div class="title"></div>
  <div class="description"></div>
</div>